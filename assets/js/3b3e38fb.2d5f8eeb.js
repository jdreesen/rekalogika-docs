"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[298],{3905:(e,t,i)=>{i.d(t,{Zo:()=>c,kt:()=>m});var n=i(7294);function r(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function a(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function l(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?a(Object(i),!0).forEach((function(t){r(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function o(e,t){if(null==e)return{};var i,n,r=function(e,t){if(null==e)return{};var i,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||(r[i]=e[i]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),i=t;return e&&(i="function"==typeof e?e(t):l(l({},t),e)),i},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",f={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var i=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=p(i),u=r,m=d["".concat(s,".").concat(u)]||d[u]||f[u]||a;return i?n.createElement(m,l(l({ref:t},c),{},{components:i})):n.createElement(m,l({ref:t},c))}));function m(e,t){var i=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=i.length,l=new Array(a);l[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[d]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<a;p++)l[p]=i[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,i)}u.displayName="MDXCreateElement"},1622:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>f,frontMatter:()=>a,metadata:()=>o,toc:()=>p});var n=i(7462),r=(i(7294),i(3905));const a={title:"Creating Filters"},l=void 0,o={unversionedId:"file/creating-filters",id:"file/creating-filters",title:"Creating Filters",description:"This chapter describes the concept of file derivation and how to create filters.",source:"@site/docs/file/51-creating-filters.md",sourceDirName:"file",slug:"/file/creating-filters",permalink:"/file/creating-filters",draft:!1,editUrl:"https://github.com/rekalogika/rekalogika-docs/docs/file/51-creating-filters.md",tags:[],version:"current",sidebarPosition:51,frontMatter:{title:"Creating Filters"},sidebar:"docs",previous:{title:"In Twig Templates",permalink:"/file/twig"},next:{title:"File Association Internal Details",permalink:"/file/entity-association-internal"}},s={},p=[{value:"Derivation",id:"derivation",level:2},{value:"Low-Level Implementation",id:"low-level-implementation",level:2},{value:"Filters",id:"filters",level:2},{value:"Developing Filters Using <code>AbstractFileFilter</code>",id:"developing-filters-using-abstractfilefilter",level:2}],c={toc:p},d="wrapper";function f(e){let{components:t,...i}=e;return(0,r.kt)(d,(0,n.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This chapter describes the concept of file derivation and how to create filters."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"This chapter is intended for developers who want to create their own filters.\nEnd users who simply want to use the ready-made filters can skip this chapter.")),(0,r.kt)("h2",{id:"derivation"},"Derivation"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"FileInterface")," supports what we call 'derivation'. A file can have one or more\nderivation of itself. For example, an image file can have a thumbnail, medium,\nand large derivation. A derived file can also be derived further. For example, a\nthumbnail can be in the original aspect ratio, or square-cropped."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"FileInterface")," provides the method ",(0,r.kt)("inlineCode",{parentName:"p"},"getDerivation()")," that returns a\n",(0,r.kt)("inlineCode",{parentName:"p"},"FilePointer")," to the derived file. Our ",(0,r.kt)("inlineCode",{parentName:"p"},"File")," objects ensure that a derivation\ncannot be made if the file is in the local filesystem, or in an ad-hoc\nfilesystem, to avoid cluttering the local filesystem with unwanted files."),(0,r.kt)("h2",{id:"low-level-implementation"},"Low-Level Implementation"),(0,r.kt)("p",null,"At the low level, a derivation is created simply by appending the derivation ID\nto the original file's key. For example, if the original file's key is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"entity/ffa87ef3fc5388bc8b666e2cec17d27cc493d0c1/image/e5/80/72/6d/31337\n")),(0,r.kt)("p",null,"then, with the derivation ID '100px', the derived file's key becomes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"entity/ffa87ef3fc5388bc8b666e2cec17d27cc493d0c1/image/e5/80/72/6d/31337.d/100px\n")),(0,r.kt)("p",null,"Deleting the original file will also result in the deletion of all of its\nderivations."),(0,r.kt)("p",null,"Derivation can be nested. Suppose the derived file above will be derived further\nwith the derivation ID of 'square', then the derived file's key becomes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"entity/ffa87ef3fc5388bc8b666e2cec17d27cc493d0c1/image/e5/80/72/6d/31337.d/100px.d/square\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Because each derivation step requires a roundtrip to the storage backend, it is\nnot recommended to nest derivations too deep.")),(0,r.kt)("h2",{id:"filters"},"Filters"),(0,r.kt)("p",null,"Derivation is the building block of filters. A filter is a service that creates\na derived file from a source file. A filter can be applied to a ",(0,r.kt)("inlineCode",{parentName:"p"},"FileInterface"),"\nand does the following:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Obtain the original file."),(0,r.kt)("li",{parentName:"ol"},"Determine the derivation ID from the parameters provided by the caller. For\nexample, if the caller wants to get a square thumbnail of an image, the\nfilter can use the derivation ID like 'thumbnail-square'."),(0,r.kt)("li",{parentName:"ol"},"Call ",(0,r.kt)("inlineCode",{parentName:"li"},"FileInterface::getDerivation()")," to get a pointer to the derived file."),(0,r.kt)("li",{parentName:"ol"},"Call ",(0,r.kt)("inlineCode",{parentName:"li"},"FileRepository::get()")," to get the derived file.",(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"If the derived file does not exist, write the derived file to it."),(0,r.kt)("li",{parentName:"ol"},"If the derived file exists and newer than the original file, return it."),(0,r.kt)("li",{parentName:"ol"},"If the derived file exists and older than the original file, create a\nderivation out of the original file, then overwrite the old derived file.")))),(0,r.kt)("p",null,"Our ",(0,r.kt)("inlineCode",{parentName:"p"},"AbstractFileFilter")," below can be used to create filters that automate\nthe above process and streamline the creation of derived files."),(0,r.kt)("h2",{id:"developing-filters-using-abstractfilefilter"},"Developing Filters Using ",(0,r.kt)("inlineCode",{parentName:"h2"},"AbstractFileFilter")),(0,r.kt)("admonition",{title:"Preparation",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"You need to install the package ",(0,r.kt)("inlineCode",{parentName:"p"},"rekalogika/file-derivation")," to use this feature:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"composer require rekalogika/file-derivation\n"))),(0,r.kt)("p",null,"To create a filter class, you can extend ",(0,r.kt)("inlineCode",{parentName:"p"},"AbstractFileFilter"),", create a method\n(or more) for the callers to specify the filtering parameters, and implement all\nthe abstract methods."),(0,r.kt)("p",null,"The following is an example filter class that creates a derived file by (rather\nuselessly) appending a text to the original content:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"use Rekalogika\\Contracts\\File\\FileInterface;\nuse Rekalogika\\File\\Derivation\\Filter\\AbstractFileFilter;\nuse Rekalogika\\File\\TemporaryFile;\n\nclass TextAppender extends AbstractFileFilter\n{\n    private string $text;\n\n    /**\n     * Your custom method that provides the parameters\n     */\n    public function appendText(string $text): self\n    {\n        assert(ctype_alpha($text)); // ensure alpha characters only\n        $this->text = $text;\n\n        return $this;\n    }\n\n    #[\\Override]\n    protected function getDerivationId(): string\n    {\n        return 'append_' . $this->text;\n    }\n\n    #[\\Override]\n    protected function process(): FileInterface\n    {\n        $originalContent = $this->getSourceFile()->getContent();\n\n        return new TemporaryFile::createFromString($originalContent . $this->text);\n    }\n}\n")),(0,r.kt)("p",null,"If you are using autoconfiguration, then you are all set. Otherwise, you need\nto tag your class with ",(0,r.kt)("inlineCode",{parentName:"p"},"rekalogika.file.derivation.filter"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"title=config/services.yaml",title:"config/services.yaml"},"services:\n    App\\TextAppender:\n        tags:\n            - { name: 'rekalogika.file.derivation.filter' }\n")),(0,r.kt)("p",null,"A caller will be able to use the above filter like the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"use Rekalogika\\Contracts\\File\\FileInterface;\n\n/** @var TextAppender $textAppender */\n/** @var FileInterface $file */\n\n$derivedFile = $textAppender\n    ->take($file)\n    ->appendText('foo')\n    ->getResult();\n")))}f.isMDXComponent=!0}}]);