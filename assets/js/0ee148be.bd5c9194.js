"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5386],{3905:(e,t,o)=>{o.d(t,{Zo:()=>p,kt:()=>h});var n=o(7294);function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){a(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t){if(null==e)return{};var o,n,a=function(e,t){if(null==e)return{};var o,n,a={},r=Object.keys(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||(a[o]=e[o]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(a[o]=e[o])}return a}var c=n.createContext({}),s=function(e){var t=n.useContext(c),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},p=function(e){var t=s(e.components);return n.createElement(c.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var o=e.components,a=e.mdxType,r=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=s(o),u=a,h=d["".concat(c,".").concat(u)]||d[u]||m[u]||r;return o?n.createElement(h,i(i({ref:t},p),{},{components:o})):n.createElement(h,i({ref:t},p))}));function h(e,t){var o=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=o.length,i=new Array(r);i[0]=u;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l[d]="string"==typeof e?e:a,i[1]=l;for(var s=2;s<r;s++)i[s]=o[s];return n.createElement.apply(null,i)}return n.createElement.apply(null,o)}u.displayName="MDXCreateElement"},697:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var n=o(7462),a=(o(7294),o(3905));const r={title:"Loading Prevention in Extra Lazy Collections"},i=void 0,l={unversionedId:"doctrine-collections-decorator/cookbook/extra-lazy-load-prevention",id:"doctrine-collections-decorator/cookbook/extra-lazy-load-prevention",title:"Loading Prevention in Extra Lazy Collections",description:"Suppose you have an entity that has a one-to-many relation with a million of",source:"@site/docs/doctrine-collections-decorator/cookbook/15-extra-lazy-load-prevention.md",sourceDirName:"doctrine-collections-decorator/cookbook",slug:"/doctrine-collections-decorator/cookbook/extra-lazy-load-prevention",permalink:"/doctrine-collections-decorator/cookbook/extra-lazy-load-prevention",draft:!1,editUrl:"https://github.com/rekalogika/rekalogika-docs/edit/main/docs/doctrine-collections-decorator/cookbook/15-extra-lazy-load-prevention.md",tags:[],version:"current",sidebarPosition:15,frontMatter:{title:"Loading Prevention in Extra Lazy Collections"},sidebar:"docs",previous:{title:"Decorating Member Objects",permalink:"/doctrine-collections-decorator/cookbook/decorating-members"},next:{title:"rekalogika/domain-event",permalink:"/domain-event/"}},c={},s=[{value:"The Decorator Class",id:"the-decorator-class",level:2},{value:"Usage Example in Entities",id:"usage-example-in-entities",level:2}],p={toc:s},d="wrapper";function m(e){let{components:t,...o}=e;return(0,a.kt)(d,(0,n.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Suppose you have an entity that has a one-to-many relation with a million of\nrelated entities. The solution is to use ",(0,a.kt)("a",{parentName:"p",href:"https://www.doctrine-project.org/projects/doctrine-orm/en/latest/tutorials/extra-lazy-associations.html"},(0,a.kt)("inlineCode",{parentName:"a"},"fetch: 'EXTRA_LAZY'"))," and ",(0,a.kt)("inlineCode",{parentName:"p"},"indexBy:\n'id'"),"."),(0,a.kt)("p",null,"This will allow working with some of the methods of the collection without\nloading the whole collection into memory. As long as you don't call the other\nmethods, you will be fine."),(0,a.kt)("p",null,"But then one of your team members forgets about it and inadvertently calls one of\nthe methods that triggers a full load of the collection. In their development\nenvironment, it appears fine because of the much smaller dataset. It would pass\nCI and be deployed to production. But in production, everything immediately\ngrinds to a halt because it tries to load a million records into memory."),(0,a.kt)("p",null,"A solution to prevent this problem is to decorate the collection to throw an\nexception if a non-safe method is called."),(0,a.kt)("p",null,"The list of safe methods is listed in the documentation of ",(0,a.kt)("a",{parentName:"p",href:"https://www.doctrine-project.org/projects/doctrine-orm/en/current/tutorials/extra-lazy-associations.html"},"Extra Lazy\nAssociation"),".\nThey are: ",(0,a.kt)("inlineCode",{parentName:"p"},"contains()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"containsKey()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"count()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"get()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"slice()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"add()"),",\nand ",(0,a.kt)("inlineCode",{parentName:"p"},"offsetSet()"),"."),(0,a.kt)("h2",{id:"the-decorator-class"},"The Decorator Class"),(0,a.kt)("p",null,"This package already comes with ready-made decorators for this purpose. For\ncompleteness, like every other of our classes, they come with four flavors\ndepending on the type of collection you are decorating:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ExtraLazyCollection")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ExtraLazyReadableCollection")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ExtraLazySelectableCollection")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ExtraLazySelectableReadableCollection"))),(0,a.kt)("p",null,"But you probably want to use ",(0,a.kt)("inlineCode",{parentName:"p"},"ExtraLazyCollection")," most of the time."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"While these decorators only allow safe methods, they still implement\n",(0,a.kt)("inlineCode",{parentName:"p"},"Collection")," (or the other interfaces) so that they can still be used in places\nwhere the original collection is expected, like ",(0,a.kt)("inlineCode",{parentName:"p"},"PagerFanta"),".")),(0,a.kt)("h2",{id:"usage-example-in-entities"},"Usage Example in Entities"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-php"},"use Doctrine\\Common\\Collections\\Collection;\nuse Doctrine\\ORM\\Mapping as ORM;\nuse Rekalogika\\Collections\\Decorator\\ExtraLazy\\ExtraLazyCollection;\n\n#[ORM\\Entity()]\nclass BookShelf\n{\n    // our bookshelf has a million of books...\n    #[ORM\\OneToMany(\n        targetEntity: Book::class,\n        fetch: 'EXTRA_LAZY', // needs this, or it will not work\n        // also needs this, or containsKey() & get() will trigger the loading:\n        indexBy: 'id', \n    )]\n    private Collection $books;\n\n    public function getBooks(): Collection\n    {\n        return new ExtraLazyCollection($this->books);\n    }\n}\n")))}m.isMDXComponent=!0}}]);